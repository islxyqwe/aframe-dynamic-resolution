var AFRAME_DynaimcResolutionComponent=function(t,r){"use strict";var n=function(t,r){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)r.hasOwnProperty(e)&&(t[e]=r[e])})(t,r)};function e(t,r){function e(){this.constructor=t}n(t,r),t.prototype=null===r?Object.create(r):(e.prototype=r.prototype,new e)}function h(t){return"function"==typeof t}var i=!1,o={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){t&&(new Error).stack;i=t},get useDeprecatedSynchronousErrorHandling(){return i}};function s(t){setTimeout(function(){throw t},0)}var c={closed:!0,next:function(t){},error:function(t){if(o.useDeprecatedSynchronousErrorHandling)throw t;s(t)},complete:function(){}},a=Array.isArray||function(t){return t&&"number"==typeof t.length};function u(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(t,r){return r+1+") "+t.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}u.prototype=Object.create(Error.prototype);var f=u,p=function(){function c(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._unsubscribe=t)}var t;return c.prototype.unsubscribe=function(){var r;if(!this.closed){var t,e=this._parentOrParents,n=this._unsubscribe,i=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,e instanceof c)e.remove(this);else if(null!==e)for(var o=0;o<e.length;++o){e[o].remove(this)}if(h(n))try{n.call(this)}catch(t){r=t instanceof f?l(t.errors):[t]}if(a(i)){o=-1;for(var s=i.length;++o<s;){var u=i[o];if(null!==(t=u)&&"object"==typeof t)try{u.unsubscribe()}catch(t){r=r||[],t instanceof f?r=r.concat(l(t.errors)):r.push(t)}}}if(r)throw new f(r)}},c.prototype.add=function(t){var r=t;if(!t)return c.EMPTY;switch(typeof t){case"function":r=new c(t);case"object":if(r===this||r.closed||"function"!=typeof r.unsubscribe)return r;if(this.closed)return r.unsubscribe(),r;if(!(r instanceof c)){var e=r;(r=new c)._subscriptions=[e]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var n=r._parentOrParents;if(null===n)r._parentOrParents=this;else if(n instanceof c){if(n===this)return r;r._parentOrParents=[n,this]}else{if(-1!==n.indexOf(this))return r;n.push(this)}var i=this._subscriptions;return null===i?this._subscriptions=[r]:i.push(r),r},c.prototype.remove=function(t){var r=this._subscriptions;if(r){var e=r.indexOf(t);-1!==e&&r.splice(e,1)}},c.EMPTY=((t=new c).closed=!0,t),c}();function l(t){return t.reduce(function(t,r){return t.concat(r instanceof f?r.errors:r)},[])}var b="function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random(),d=function(i){function o(t,r,e){var n=i.call(this)||this;switch(n.syncErrorValue=null,n.syncErrorThrown=!1,n.syncErrorThrowable=!1,n.isStopped=!1,arguments.length){case 0:n.destination=c;break;case 1:if(!t){n.destination=c;break}if("object"==typeof t){t instanceof o?(n.syncErrorThrowable=t.syncErrorThrowable,(n.destination=t).add(n)):(n.syncErrorThrowable=!0,n.destination=new y(n,t));break}default:n.syncErrorThrowable=!0,n.destination=new y(n,t,r,e)}return n}return e(o,i),o.prototype[b]=function(){return this},o.create=function(t,r,e){var n=new o(t,r,e);return n.syncErrorThrowable=!1,n},o.prototype.next=function(t){this.isStopped||this._next(t)},o.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},o.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},o.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,i.prototype.unsubscribe.call(this))},o.prototype._next=function(t){this.destination.next(t)},o.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},o.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},o.prototype._unsubscribeAndRecycle=function(){var t=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=t,this},o}(p),y=function(u){function t(t,r,e,n){var i,o=u.call(this)||this;o._parentSubscriber=t;var s=o;return h(r)?i=r:r&&(i=r.next,e=r.error,n=r.complete,r!==c&&(h((s=Object.create(r)).unsubscribe)&&o.add(s.unsubscribe.bind(s)),s.unsubscribe=o.unsubscribe.bind(o))),o._context=s,o._next=i,o._error=e,o._complete=n,o}return e(t,u),t.prototype.next=function(t){if(!this.isStopped&&this._next){var r=this._parentSubscriber;o.useDeprecatedSynchronousErrorHandling&&r.syncErrorThrowable?this.__tryOrSetError(r,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},t.prototype.error=function(t){if(!this.isStopped){var r=this._parentSubscriber,e=o.useDeprecatedSynchronousErrorHandling;if(this._error)e&&r.syncErrorThrowable?this.__tryOrSetError(r,this._error,t):this.__tryOrUnsub(this._error,t),this.unsubscribe();else if(r.syncErrorThrowable)e?(r.syncErrorValue=t,r.syncErrorThrown=!0):s(t),this.unsubscribe();else{if(this.unsubscribe(),e)throw t;s(t)}}},t.prototype.complete=function(){var t=this;if(!this.isStopped){var r=this._parentSubscriber;if(this._complete){var e=function(){return t._complete.call(t._context)};o.useDeprecatedSynchronousErrorHandling&&r.syncErrorThrowable?this.__tryOrSetError(r,e):this.__tryOrUnsub(e),this.unsubscribe()}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(t,r){try{t.call(this._context,r)}catch(t){if(this.unsubscribe(),o.useDeprecatedSynchronousErrorHandling)throw t;s(t)}},t.prototype.__tryOrSetError=function(r,t,e){if(!o.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,e)}catch(t){return o.useDeprecatedSynchronousErrorHandling?(r.syncErrorValue=t,r.syncErrorThrown=!0):(s(t),!0)}return!1},t.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},t}(d);var _="function"==typeof Symbol&&Symbol.observable||"@@observable";function v(){}var w=function(){function e(t){this._isScalar=!1,t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,e){var n=this.operator,i=function(t,r,e){if(t){if(t instanceof d)return t;if(t[b])return t[b]()}return t||r||e?new d(t,r,e):new d(c)}(t,r,e);if(n?i.add(n.call(i,this.source)):i.add(this.source||o.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),o.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},e.prototype._trySubscribe=function(r){try{return this._subscribe(r)}catch(t){o.useDeprecatedSynchronousErrorHandling&&(r.syncErrorThrown=!0,r.syncErrorValue=t),!function(t){for(;t;){var r=t,e=r.closed,n=r.destination,i=r.isStopped;if(e||i)return!1;t=n&&n instanceof d?n:null}return!0}(r)?console.warn(t):r.error(t)}},e.prototype.forEach=function(n,t){var i=this;return new(t=g(t))(function(t,r){var e;e=i.subscribe(function(t){try{n(t)}catch(t){r(t),e&&e.unsubscribe()}},r,t)})},e.prototype._subscribe=function(t){var r=this.source;return r&&r.subscribe(t)},e.prototype[_]=function(){return this},e.prototype.pipe=function(){for(var t=arguments,r=[],e=0;e<arguments.length;e++)r[e]=t[e];return 0===r.length?this:function(r){return r?1===r.length?r[0]:function(t){return r.reduce(function(t,r){return r(t)},t)}:v}(r)(this)},e.prototype.toPromise=function(t){var n=this;return new(t=g(t))(function(t,r){var e;n.subscribe(function(t){return e=t},function(t){return r(t)},function(){return t(e)})})},e.create=function(t){return new e(t)},e}();function g(t){if(!(t=t||Promise))throw new Error("no Promise impl found");return t}function m(r,e){return function(t){if("function"!=typeof r)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return t.lift(new E(r,e))}}var E=function(){function t(t,r){this.project=t,this.thisArg=r}return t.prototype.call=function(t,r){return r.subscribe(new S(t,this.project,this.thisArg))},t}(),S=function(i){function t(t,r,e){var n=i.call(this,t)||this;return n.project=r,n.count=0,n.thisArg=e||n,n}return e(t,i),t.prototype._next=function(t){var r;try{r=this.project.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}this.destination.next(r)},t}(d);var x=function(){function t(t,r){this.predicate=t,this.thisArg=r}return t.prototype.call=function(t,r){return r.subscribe(new O(t,this.predicate,this.thisArg))},t}(),O=function(i){function t(t,r,e){var n=i.call(this,t)||this;return n.predicate=r,n.thisArg=e,n.count=0,n}return e(t,i),t.prototype._next=function(t){var r;try{r=this.predicate.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}r&&this.destination.next(t)},t}(d);var T=function(){function t(t,r){this.bufferSize=t,this.startBufferEvery=r,this.subscriberClass=r&&t!==r?A:P}return t.prototype.call=function(t,r){return r.subscribe(new this.subscriberClass(t,this.bufferSize,this.startBufferEvery))},t}(),P=function(n){function t(t,r){var e=n.call(this,t)||this;return e.bufferSize=r,e.buffer=[],e}return e(t,n),t.prototype._next=function(t){var r=this.buffer;r.push(t),r.length==this.bufferSize&&(this.destination.next(r),this.buffer=[])},t.prototype._complete=function(){var t=this.buffer;0<t.length&&this.destination.next(t),n.prototype._complete.call(this)},t}(d),A=function(i){function t(t,r,e){var n=i.call(this,t)||this;return n.bufferSize=r,n.startBufferEvery=e,n.buffers=[],n.count=0,n}return e(t,i),t.prototype._next=function(t){var r=this.bufferSize,e=this.startBufferEvery,n=this.buffers,i=this.count;this.count++,i%e==0&&n.push([]);for(var o=n.length;o--;){var s=n[o];s.push(t),s.length===r&&(n.splice(o,1),this.destination.next(s))}},t.prototype._complete=function(){for(var t=this.buffers,r=this.destination;0<t.length;){var e=t.shift();0<e.length&&r.next(e)}i.prototype._complete.call(this)},t}(d),H=r.registerComponent("dynamic-resolution",{schema:{targetFPS:{default:60},debug:{default:!1}},timer:0,scale:1,handler:new d,resolution_controller:function(t){var r=this;return t.pipe(function(r,e){return void 0===e&&(e=null),function(t){return t.lift(new T(r,e))}}(4),m(function(t){return t.reduce(j)*r.data.targetFPS/4e3-1}),function(r,e){return function(t){return t.lift(new x(r,e))}}(function(t){return t<1}),m(function(t){return 0<t?5*t:.2*Math.log(-t)}),D(60),m(function(t){return t<0})).subscribe(function(t){if(t&&r.scale<1)r.scale=r.scale+.05;else{if(t||!(.75<r.scale))return;r.scale=r.scale-.05}r.data.debug&&console.log("change scale to",r.scale)})},init:function(){var r=this;this.timer=performance.now(),this.resolution_controller(new w(function(t){r.handler=t}))},play:function(){this.timer=performance.now()},remove:function(){this.handler.complete()},tick:function(){var t=performance.now()-this.timer;this.handler.next(t),this.resize(),this.timer=performance.now()},resize:function(){var t=this.el,r=function(t,r,e,n){if(r&&t.parentElement)return{height:t.parentElement.offsetHeight,width:t.parentElement.offsetWidth};return function(t,r){var e,n,i=window.devicePixelRatio;if(n={height:document.body.offsetHeight,width:document.body.offsetWidth},!t||r||-1===t.width&&-1===t.height)return n;if(n.width*i<t.width&&n.height*i<t.height)return n;e=n.width/n.height,n.width*i>t.width&&-1!==t.width&&(n.width=Math.round(t.width/i),n.height=Math.round(t.width/e/i));n.height*i>t.height&&-1!==t.height&&(n.height=Math.round(t.height/i),n.width=Math.round(t.height*e/i));return n}(e,n)}(t.canvas,t.getAttribute("embedded")&&!t.is("vr-mode"),t.maxCanvasSize,t.is("vr-mode"));t.renderer.setSize(r.width*this.scale,r.height*this.scale,!1)}}),D=function(n){return function(t){return new w(function(r){var e=0;return t.subscribe({next:function(t){0===e||0<e&&0<t||e<0&&t<0?e+=t:e=e/10+t,Math.abs(e)>n&&(r.next(e),e=0)},error:function(t){r.error(t)},complete:function(){r.complete()}})})}};function j(t,r){return t+r}return t.Component=H,t}({},AFRAME);
//# sourceMappingURL=aframe-dynamic-resolution.js.map
